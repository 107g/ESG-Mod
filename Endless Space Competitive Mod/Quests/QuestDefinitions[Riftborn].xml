<?xml version="1.0" encoding="utf-8" ?>
<Datatable xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:noNamespaceSchemaLocation="../Schemas/QuestDefinition.xsd">
  <QuestDefinition Name="TimeLordsQuest-Chapter1.Part1" Category="MajorQuest" SubCategory="TimeLords" MinimumTurn="5">

    <!--============ TAGS ============-->
    <Tags>BeginTurn</Tags>

    <!--============ CONTEXT ============-->
    <QuestContextSolo/>

    <!--============ OCCURRENCE RULES ============-->
    <RepetitionRules  NumberOfOccurrencesPerGame="0"
                      NumberOfOccurrencesPerEmpire="1"
                      NumberOfConcurrentInstances="0"/>

    <!--============ VARIABLES ============-->
    <Vars>
      <Var VarName="$CurrentEmpire">
        <From Source="$Empire"/>
      </Var>
      <Var VarName="$MyHomeSystem">
        <From Source="$Empire.$HomeStarSystem"/>
      </Var>
      <Var VarName="$AllStarSystems">
        <From Source="$Constellations.$StarSystems"/>
      </Var>
      <Var VarName="$AllStarSystemsClose">
        <From Source="$AllStarSystems">
          <OrderBy>
            <SortSystemByDistance OriginVarName="$MyHomeSystem" SortBy="Farthest" MinimumDistance="10" MaximumDistance="60" MinimumCandidateCount="5"/>
          </OrderBy>
        </From>
      </Var>
      <Var VarName="$FirstSystem">
        <Any>
          <From Source="$AllStarSystemsClose"/>
        </Any>
      </Var>
      <Var VarName="$SecondSystem">
        <Any>
          <From Source="$AllStarSystemsClose">
            <Where>
              <IsNot EntityVarName="$FirstSystem"/>
            </Where>
          </From>
        </Any>
      </Var>
      <Var VarName="$ThirdSystem">
        <Any>
          <From Source="$AllStarSystemsClose">
            <Where>
              <IsNot EntityVarName="$FirstSystem"/>
              <IsNot EntityVarName="$SecondSystem"/>
            </Where>
          </From>
        </Any>
      </Var>
      <Var VarName="$Planet01">
        <Any>
          <From Source="$FirstSystem.$Planets"/>
        </Any>
      </Var>
      <Var VarName="$Planet02">
        <Any>
          <From Source="$SecondSystem.$Planets"/>
        </Any>
      </Var>
      <Var VarName="$Planet03">
        <Any>
          <From Source="$ThirdSystem.$Planets"/>
        </Any>
      </Var>

      <Var VarName="$Curiosity01" StringValue="Curiosity_Loot_Lifeform_Era2"/>
      <Var VarName="$Curiosity02" StringValue="Curiosity_Loot_Signal_Era2"/>
      <Var VarName="$Curiosity03" StringValue="Curiosity_Loot_Underground_Era2"/>
      <Var VarName="$Curiosity01GUID"/>
      <Var VarName="$Curiosity02GUID"/>
      <Var VarName="$Curiosity03GUID"/>
      <!--Required Curiosities-->
      <Var VarName="$Amount01" IntValue="7"/>
      <!--Hero Level-->
      <Var VarName="$Amount05" IntValue="3"/>
      <!--Improvements we have to Build-->
      <Var VarName="$Amount02" IntValue="7"/>

      <Var VarName="$Path" StringValue="ClassEmpire/ClassColonizedStarSystem"/>
      <Var VarName="$SubPath" StringValue="ClassColonizedStarSystem/ClassImprovement"/>
      <Var VarName="$Tag" StringValue="ClassImprovement"/>
      <Var VarName="$Count" IntValue="1"/>
      <Var VarName="$SubCount" IntValue="9"/>


      <!--MinorFaction NB-->
      <Var VarName="$Amount03" IntValue="1"/>
      <!--Nb of required  points-->
      <Var VarName="$Amount04" IntValue="50"/>
      <Var VarName="$Amount06" IntValue="1"/>
      <Var VarName="$Assimilate" StringValue="DiplomaticRelationStateMinorAdvancedBrainwashed"/>
      <Var VarName="$FleetGUID"/>

      <Var VarName="$PoliticalEffectEcologist"         StringValue="PopulationEventTimeLords01-Ecologist"/>
      <Var VarName="$PoliticalEffectIndustrialist"     StringValue="PopulationEventTimeLords01-Industrialist"/>
      <Var VarName="$PoliticalEffectPacifist"          StringValue="PopulationEventTimeLords01-Pacifist"/>

      <!--Required Curiosities-->
      <LocalizationVar Source="$Amount01" LocalizationKey="$Amount01Name"/>
      <!--Improvements we have to Build-->
      <LocalizationVar Source="$Amount02" LocalizationKey="$Amount02Name"/>
      <!--MinorFaction NB-->
      <LocalizationVar Source="$Amount03" LocalizationKey="$Amount03Name"/>
      <!--Nb of required points-->
      <LocalizationVar Source="$Amount04" LocalizationKey="$Amount04Name"/>
      <!--Hero Level-->
      <LocalizationVar Source="$Amount05" LocalizationKey="$Amount05Name"/>
    </Vars>

    <!--============ PREREQUISITES ============-->

    <Prerequisites Target="$(Empire)">
      <PathPrerequisite Flags="Prerequisite">EmpireTypeMajor/ClassPopulation,ClassPopulationEmpireAffinityTimeLords,PopulationMajor</PathPrerequisite>
      <PathPrerequisite Flags="Prerequisite">EmpireTypeMajor/ClassStarSystem,HomeSystem</PathPrerequisite>
    </Prerequisites>


    <!--============ STEPS ============-->
    <Steps>
      <Step Name="Step1">
        <!--============ STEP 0 - Choose ============-->
        <Choice DefaultChoiceIndex="0">
          <ChoiceItem ObjectiveSetIndex="0"/>
          <ChoiceItem ObjectiveSetIndex="1"/>
          <ChoiceItem ObjectiveSetIndex="2"/>
        </Choice>

        <!--============ Choice Index 0: Ecologist ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectEcologist"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Objective_Ecologist" StartValue="0" EndValue="$Amount01">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="25" MaxAutoResolutionTurn="35" AutoResolutionProbability="1" />
            <Sequence>
              <Action_SpawnCuriosity>
                <Input_Empires VarName="$CurrentEmpire"/>
                <Input_Planets VarName="$Planet01"/>
                <Input_CuriosityDefinition VarName="$Curiosity01"/>
                <Output_CuriosityGUIDs VarName="$Curiosity01GUID"/>
              </Action_SpawnCuriosity>
              <Loop Count="2">
                <Action_SpawnCuriosity>
                  <Input_Empires VarName="$CurrentEmpire"/>
                  <Input_Planets VarName="$Planet02"/>
                  <Input_CuriosityDefinition VarName="$Curiosity02"/>
                  <Output_CuriosityGUIDs VarName="$Curiosity02GUID"/>
                </Action_SpawnCuriosity>
                <Action_SpawnCuriosity>
                  <Input_Empires VarName="$CurrentEmpire"/>
                  <Input_Planets VarName="$Planet03"/>
                  <Input_CuriosityDefinition VarName="$Curiosity03"/>
                  <Output_CuriosityGUIDs VarName="$Curiosity03GUID"/>
                </Action_SpawnCuriosity>
              </Loop>
              <Loop>
                <Decorator_CuriosityDiscovered OnlyAllowDiscoveryByFleet="true" Initiator="Empire" ProgressionIncrement="1">
                  <Output_FleetGUID VarName="$FleetGUID"/>
                </Decorator_CuriosityDiscovered>
                <Input_Count VarName="$Amount01"/>
              </Loop>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>TimeLordsQuest-Chapter1.Part2</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistMinorRewardsEra3" Picks="1"/>

        </ObjectiveSet>

        <!--============ Choice Index 1: INDUSTRIALIST ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectIndustrialist"/>
            </Action_TriggerPopulationEvent>
          </StartActions>

          <Objective Name="Objective_Industrialist">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="25" MaxAutoResolutionTurn="35" AutoResolutionProbability="1" />
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_CountSimulationObjectsWithTag Composition="Minimum" SubComposition="Minimum">
                  <Input_SimulationObjects VarName="$CurrentEmpire"/>
                  <Input_Path VarName="$Path"/>
                  <Input_SubPath VarName="$SubPath"/>
                  <Input_Tag VarName="$Tag"/>
                  <Input_Minimum VarName="$Count"/>
                  <Input_SubMinimum VarName="$SubCount"/>
                </Condition_CountSimulationObjectsWithTag>
              </Decorator_BeginTurn>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>TimeLordsQuest-Chapter1.Part2</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistMinorRewardsEra3" Picks="1"/>

        </ObjectiveSet>

        <!--============ Choice Index 2: Pacifist ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectPacifist"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Objective_Pacifist">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="25" MaxAutoResolutionTurn="35" AutoResolutionProbability="1" />
            <Sequence>
              <Parallel CompletionPolicy="Any">
                <Sequence>
                  <Decorator_BeginTurn>
                    <Condition_MinorFactionRelationship>
                      <Input_MajorEmpire VarName="$CurrentEmpire"/>
                      <Input_NumberOfMinorFactions VarName="$Amount03"/>
                      <Input_MinimumRelationPoints VarName="$Amount04"/>
                    </Condition_MinorFactionRelationship>
                  </Decorator_BeginTurn>
                </Sequence>
                <Sequence>
                  <Parallel CompletionPolicy="All">
                    <Sequence>
                      <Decorator_BeginTurn>
                        <Condition_MinorFactionRelationship>
                          <Input_MajorEmpire VarName="$CurrentEmpire"/>
                          <Input_NumberOfMinorFactions VarName="$Amount06"/>
                          <Input_MinimumRelationPoints VarName="$Amount04"/>
                        </Condition_MinorFactionRelationship>
                      </Decorator_BeginTurn>
                    </Sequence>
                    <Sequence>
                      <Decorator_BeginTurn>
                        <Condition_MinorFactionRelationship>
                          <Input_MajorEmpire VarName="$CurrentEmpire"/>
                          <Input_NumberOfMinorFactions VarName="$Amount06"/>
                          <Input_DiplomaticRelationState VarName="$Assimilate"/>
                        </Condition_MinorFactionRelationship>
                      </Decorator_BeginTurn>
                    </Sequence>
                  </Parallel>
                  <Sequence>
                    <Decorator_BeginTurn>
                      <Condition_MinorFactionRelationship>
                        <Input_MajorEmpire VarName="$CurrentEmpire"/>
                        <Input_NumberOfMinorFactions VarName="$Amount03"/>
                        <Input_DiplomaticRelationState VarName="$Assimilate"/>
                      </Condition_MinorFactionRelationship>
                    </Decorator_BeginTurn>
                  </Sequence>
                </Sequence>
              </Parallel>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>TimeLordsQuest-Chapter1.Part2</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistMinorRewardsEra3" Picks="1"/>

        </ObjectiveSet>
      </Step>
    </Steps>
  </QuestDefinition>
</Datatable>