<?xml version="1.0" encoding="utf-8" ?>
<Datatable xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:noNamespaceSchemaLocation="../Schemas/QuestDefinition.xsd">
  <QuestDefinition Name="UE_Quest-Chapter3" Category="MajorQuest" SubCategory="UE" MinimumTurn="1">

    <!--============ TAGS ============-->
    <Tags>UE_Quest-Chapter3</Tags>

    <QuestContextSolo/>


    <RepetitionRules  NumberOfOccurrencesPerGame="0"
                      NumberOfOccurrencesPerEmpire="1"
                      NumberOfConcurrentInstances="0"/>

    <!--============ VARIABLES ============-->
    <Vars>
      <Var VarName="$CurrentEmpire">
        <From Source="$Empire"/>
      </Var>
      <Var VarName="$Amount01Objective" IntValue="15"/>
      <Var VarName="$TradeRouteAmount" IntValue="6"/>
      <Var VarName="$ScienceResources" StringValue="EmpireResearch"/>
      <Var VarName="$Technology01" StringValue="TechnologyDefinitionQuestUE06"/>

      <Var VarName="$PoliticalEffectMilitary" StringValue="PopulationEventUE03Military"/>
      <Var VarName="$PoliticalEffectIndustry" StringValue="PopulationEventUE03Industry"/>
      <Var VarName="$PoliticalEffectScience"  StringValue="PopulationEventUE03Science"/>

      <InterpretedVar VarName="$ScienceAmountStart" Target="$(Empire)">
        <Expression>Property(Context, @'ClassEmpire', NetEmpireResearch)</Expression>
      </InterpretedVar>

      <InterpretedVar VarName="$ScienceAmount" Target="$(Empire)">
        <Expression>Property(Context, @'ClassEmpire', NetEmpireResearch)+200</Expression>
      </InterpretedVar>

      <Var VarName="$Expression" StringValue="Property(Context, @'ClassEmpire', NetEmpireResearch)"/>

      <InterpretedVar VarName="$Amount01Start" Target="$(Empire)">
        <Expression>Property(Context, @'ClassEmpire', MaximumCommandPoints)</Expression>
      </InterpretedVar>

      <Var VarName="$Expression1" StringValue="Property(Context, @'ClassEmpire', MaximumCommandPoints)"/>

      <Var IsGlobal="true" VarName="$ChosenHero"/>
      <LocalizationVar Source="$ChosenHero"     LocalizationKey="$HeroName"/>

      <InterpretedVar VarName="$Amount02" Target="$(Empire)">
        <Expression>Property(Context, @'ClassEmpire//ClassTradingCompany', Level,true)+1</Expression>
      </InterpretedVar>
      <InterpretedVar VarName="$Amount03" Target="$(Empire)">
        <Expression>Property(Context, @'ClassEmpire//ClassTradingCompany', Level,true)+4</Expression>
      </InterpretedVar>
      <Var VarName="$Expression2" StringValue="Property(Context, @'ClassEmpire//ClassTradingCompany', Level,true)+1"/>
      <LocalizationVar LocalizationKey="$Amount03Name" Source="$Amount03"/>

      <LocalizationVar LocalizationKey="$MaxCommandPointsAmount" Source="$Amount01Objective"/>
      <LocalizationVar LocalizationKey="$TradeRouteAmountName" Source="$TradeRouteAmount"/>
      <LocalizationVar LocalizationKey="$ScienceAmoutName" Source="$ScienceAmount"/>
    </Vars>

    <!--============ PREREQUISITES ============-->

    <!--============ STEPS ============-->
    <Steps>
      <Step Name="Step1">
        <!--============ STEP 0 - Choose ============-->
        <Choice DefaultChoiceIndex="0">
          <ChoiceItem ObjectiveSetIndex="0"/>
          <ChoiceItem ObjectiveSetIndex="1">
            <Prerequisites Target="$(Empire)">
              <PathPrerequisite Flags="Prerequisite" Inverted="true">../ClassEmpire,EmpireTypeMajor,AffinityGameplayUmbralChoir</PathPrerequisite>
            </Prerequisites>
          </ChoiceItem>
          <ChoiceItem ObjectiveSetIndex="2">
            <Prerequisites Target="$(Empire)">
              <PathPrerequisite Flags="Prerequisite">../ClassEmpire,EmpireTypeMajor,AffinityGameplayUmbralChoir</PathPrerequisite>
            </Prerequisites>
          </ChoiceItem>
          <ChoiceItem ObjectiveSetIndex="3"/>
        </Choice>

        <!--============ STEP 1 - MILITARY ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectMilitary"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_1_Objective1" StartValue="$Amount01Start" EndValue="$Amount01Objective">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="45" MaxAutoResolutionTurn="60" AutoResolutionProbability="1" />
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_IsProgressionComplete>
                  <Input_Context VarName="$CurrentEmpire"/>
                  <Input_EmpireWhoseProgressToUpdate VarName="$CurrentEmpire"/>
                  <Input_Expression VarName="$Expression1"/>
                </Condition_IsProgressionComplete>
              </Decorator_BeginTurn>
              <Action_SwitchEmpireFaction FactionName="FactionSheredyn" >
                <Input_Empire VarName="$CurrentEmpire"/>
              </Action_SwitchEmpireFaction>
              <Action_UnlockTechnology>
                <Input_Empire VarName="$CurrentEmpire"/>
                <Input_TechnologyName VarName="$Technology01"/>
              </Action_UnlockTechnology>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter4.1-Sheredyn</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistRewardQuestUnitedEmpire07" Picks="1"/>
          <Reward Droplist="DroplistRewardQuestUnitedEmpire07Faction" Picks="1"/>
        </ObjectiveSet>

        <!--============ STEP 2 - INDUSTRY ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectIndustry"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_2_Objective1">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="45" MaxAutoResolutionTurn="60" AutoResolutionProbability="1" />
            <!--Spawn the good fleet-->
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_HasTradeRoutes>
                  <Input_Empire VarName="$CurrentEmpire"/>
                  <Input_TradeRouteAmount VarName="$TradeRouteAmount"/>
                </Condition_HasTradeRoutes>
              </Decorator_BeginTurn>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter4.1-UE</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistRewardQuestUnitedEmpire08" Picks="1"/>
          <Reward Droplist="DroplistRewardQuestUnitedEmpire08Faction" Picks="1"/>
        </ObjectiveSet>

        <!--============ STEP 2 - INDUSTRY (UC VERSION) ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectIndustry"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_2_Objective1Alt" StartValue="$Amount02" EndValue="$Amount03">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="45" MaxAutoResolutionTurn="60" AutoResolutionProbability="1" />
            <!--Spawn the good fleet-->
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_IsProgressionComplete>
                  <Input_Context VarName="$CurrentEmpire"/>
                  <Input_Expression VarName="$Expression2"/>
                </Condition_IsProgressionComplete>
              </Decorator_BeginTurn>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter4.1-UE</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistRewardQuestUnitedEmpire08" Picks="1"/>
          <Reward Droplist="DroplistRewardQuestUnitedEmpire08Faction" Picks="1"/>
        </ObjectiveSet>

        <!--============ STEP 1 - SCIENCE ============-->

        <ObjectiveSet ObjectiveComposition="All">
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectScience"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_3_Objective1" EndValue="$ScienceAmount" StartValue="$ScienceAmountStart">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="45" MaxAutoResolutionTurn="60" AutoResolutionProbability="1" />
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_IsProgressionComplete>
                  <Input_Context VarName="$CurrentEmpire"/>
                  <Input_EmpireWhoseProgressToUpdate VarName="$CurrentEmpire"/>
                  <Input_Expression VarName="$Expression"/>
                </Condition_IsProgressionComplete>
              </Decorator_BeginTurn>

              <Action_SwitchEmpireFaction FactionName="FactionMezari" >
                <Input_Empire VarName="$CurrentEmpire"/>
              </Action_SwitchEmpireFaction>

              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter4.1-Mezari</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistRewardQuestUnitedEmpire09" Picks="1"/>
          <Reward Droplist="DroplistRewardQuestUnitedEmpire09Faction" Picks="1"/>
        </ObjectiveSet>
      </Step>
    </Steps>
  </QuestDefinition>
</Datatable>